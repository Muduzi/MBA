{%load static%}
{%load enumerate_filter%}
<link rel="stylesheet" type="text/css" href="{% static 'css/catalogue/viewProduct.css'%}" xmlns="http://www.w3.org/1999/html">

<link rel="stylesheet" type="text/css" href="{% static 'css/catalogue/catalogueMessages.css'%}" xmlns="http://www.w3.org/1999/html">

<link rel="stylesheet" type="text/css" href="{% static 'css/catalogue/catalogueLoginSignupForm.css'%}" xmlns="http://www.w3.org/1999/html">


<meta name="viewport" content="width=device-width, initial-scale=1">
<!--Javascript-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!--Chart.js plugin-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"
        integrity="sha512-JPcRR8yFa8mmCsfrw4TNte1ZvF1e3+1SdGMslZvmrzDYxS69J7J49vkFL8u6u8PlPJK+H3voElBtUCzaXj+6ig=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>
<!link for Google icons>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


{%include 'catalogue/catalogueMessages.html'%}

{%include 'catalogue/catalogueLoginSignupForm.html'%}


<form method="post" class="Navigation" id="navigationBar">
    {%csrf_token%}
    <div class="contact_edit">
        <button type ='button' onclick="showContact()">
            <i class="fa fa-phone"></i>
        </button>
        {%if allowed%}
            <button type ='submit' name="edit">
                <i class="material-icons" style="font-size:18px;">edit</i>
            </button>
            <button type="submit" name="delete">
                <i class="material-icons" style="font-size:18px;">delete</i>
            </button>
        {%endif%}
    </div>
    {%if back_url%}
        <button type="button" onclick="window.location.href='{{back_url}}';">
            <i class="material-icons" style="font-size:18px">arrow_forward</i>
        </button>
    {%else%}
        <button type ='button' onclick="window.location.href='/category/{{product.Category}}/';">
            <i class="material-icons" style="font-size:20px;">arrow_forward</i>
        </button>
    {%endif%}
</form>

<div class="product_container">
    <div class="product" id="lpv">
        <button  type="button" id="previousImage" class="prev_next">
            <i class="material-icons" style="font-size:25px; border:hidden;" >chevron_left</i>
        </button>
        <div class="product_image">
            <img id="currentImage" src="{{product.images.0}}" alt="no more images to display">
        </div>
        <button id="nextImage" type="button" class="prev_next">
            <i class="material-icons" style="font-size:25px; border:hidden;" >chevron_right</i>
        </button>
    </div>
    <div class="image_list">
        {%for index, image in product.images|enumerate_list%}
            <div class="image_list_image">
                <img src="{{image}}" alt="no more images to display">
                {%if index == 0%}
                    <div id="0" class="remove_curtain"></div>
                {%else%}
                    <div id="{{index}}" class="image_curtain"></div>
                {%endif%}
            </div>
        {%endfor%}
    </div>
    <div class="name_price_likes_comments">
        <div class="name_price">
            <text class="name">{{product.Name}}</text>
            <text class="price">K{{product.Price}}</text>
        </div>
        <form method="post" id="likeComment" class="likes_comments">
            {%csrf_token %}
            {%if registration_form%}
                <button type="button" onclick="openSignupLogin()" class="likes_count">
                    {% if product.user_liked%}
                        <i class="material-icons" style="font-size:15px;">thumb_up</i>
                    {%else%}
                        <i class="material-icons" style="font-size:15px; color:gray;">thumb_up</i>
                    {%endif%}
                    &nbsp;{{product.likes}}
                </button>

                <button type="button" onclick="openSignupLogin()" class="likes_count">
                    {% if product.user_unliked%}
                        <i class="material-icons" style="font-size:15px;">thumb_down</i>
                    {%else%}
                        <i class="material-icons" style="font-size:15px; color:gray;">thumb_down</i>
                    {%endif%}
                    &nbsp;{{product.unlikes}}
                </button>

                <button type="button" name="comment" onclick="openSignupLogin()" class="comments_count">
                     <i class="material-icons" style="font-size:18px;">comment</i>&nbsp;{{product.comment_count}}
                </button>
            {%else%}
                <button type="submit" name="like" class="likes_count">
                    {% if product.user_liked%}
                        <i class="material-icons" style="font-size:15px;">thumb_up</i>
                    {%else%}
                        <i class="material-icons" style="font-size:15px; color:gray;">thumb_up</i>
                    {%endif%}
                    &nbsp;{{product.likes}}
                </button>

                <button type="submit" name="unlike" class="likes_count">
                    {% if product.user_unliked%}
                        <i class="material-icons" style="font-size:15px;">thumb_down</i>
                    {%else%}
                        <i class="material-icons" style="font-size:15px; color:gray;">thumb_down</i>
                    {%endif%}
                    &nbsp;{{product.unlikes}}
                </button>

                <button type="button" name="comment" onclick="openCommentsForm()" class="comments_count">
                     <i class="material-icons" style="font-size:18px;">comment</i>&nbsp;{{product.comment_count}}
                </button>
            {%endif%}

        </form>
    </div>
</div>

<div class="details">
    <div class="description">
        <text class="description_title">Description</text>
        <text class="description_content">{{product.Description}}</text>
    </div>
    <table>
        <thead>
            <tr>
                <th class="t1">Specification</th>
                <th class="t2">Detail</th>
            </tr>
        </thead>
        <tbody>
        {%for i in product.features.values%}
            <tr>
                <td class="t1">{{i.Name}}</td>
                <td class="t2">{{i.Description}}</td>
            </tr>
        {%endfor%}
        </tbody>
    </table>
</div>

<div class="contact" id="contact">
    <div class="close">
        <button type="button" onclick="hideContact()" style="font-size:20px;">
            <i class="fa fa-close"></i>
        </button>
    </div>
    <text>Phone: +265 {{bus_data.Contact1}}</text>
    <text>Email: <a href="mailto:{{bus_data.Email}}">{{bus_data.Email}}</a></text>
    <div class="links">
        <a href="https://{{bus_data.Instagram}}" class="fa fa-instagram"></a>
        <a href="https://{{bus_data.Facebook}}" class="fa fa-facebook"></a>
        <a href="https://wa.me/{{bus_data.Contact2}}/" class="fa fa-whatsapp"></a>
    </div>
</div>

<form method="post" id="comments" class="comments">
    {%csrf_token%}
    <div class="close_blured_curtain">
        <button type="button" onclick="closeCommentsForm()">
            <i class="material-icons" style="font-size:20px;">close</i>
        </button>
    </div>

    <div class="comment_list">
        {%for key, c in product.comments.items%}
            {%if c.sub_comments%}
                <div class="thread">
                    <div class="comment">
                        <div class="comment_user_and_date">
                            <div class="user_image_and_name">
                                {%if c.photo%}
                                    <img src="{{c.photo}}">
                                {%else%}
                                    <img src="{% static '/appdefaults/add-photo3.png' %}" alt="add image" class="rounded-circle">
                                {%endif%}
                                <text>{{c.user_name}}</text>
                            </div>
                            <text class="date">{{c.date.date}}</text>
                        </div>
                        <text class="comment_text">{{c.comment}}</text>

                        <div class="like_reply_comment">
                            {%if c.user_name == request.user.get_full_name%}
                                <button type="submit" name="delete comment" value="{{key}}">
                                    <i class="material-icons" style="font-size:15px;">delete</i>
                                </button>
                            {%endif%}
                            {%if c.user_liked_comment%}
                                <button type="submit" name="like comment" value="{{key}}">
                                    <i class="material-icons" style="font-size:15px;">thumb_up</i>
                                    {{c.comment_like_count}}
                                </button>
                            {%else%}
                                <button type="submit" name="like comment" value="{{key}}">
                                    <i class="material-icons" style="font-size:15px;">thumb_up</i>
                                    {{c.comment_like_count}}
                                </button>
                            {%endif%}
                            {%if c.user_unliked_comment%}
                                <button type="submit" name="unlike comment" value="{{key}}">
                                    <i class="material-icons" style="font-size:15px;">thumb_down</i>
                                    {{c.comment_unlike_count}}
                                </button>
                            {%else%}
                                <button type="submit" name="unlike comment" value="{{key}}">
                                    <i class="material-icons" style="font-size:15px;">thumb_down</i>
                                    {{c.comment_unlike_count}}
                                </button>
                            {%endif%}
                            <button type="button" name="reply to comment" value="{{key}}" onclick="replyTo('{{key}}', '{{c.user_name}}')">
                                <i class="material-icons" style="font-size:15px;">reply</i>reply
                            </button>
                        </div>
                    </div>
                    {%for sub_key, s in c.sub_comments.items%}
                        <div class="sub_comment">
                            <div class="comment_user_and_date">
                                <div class="user_image_and_name">
                                    {%if s.photo%}
                                        <img src="{{s.photo}}">
                                    {%else%}
                                        <img src="{% static '/appdefaults/add-photo3.png' %}" alt="add image" class="rounded-circle">
                                    {%endif%}
                                    <text>{{s.user_name}}</text>
                                </div>
                                <text class="date">{{s.date.date}}</text>
                            </div>
                            <text class="comment_text">{{s.comment}}</text>

                            <div class="like_reply_comment">
                                {%if s.user_name == request.user.get_full_name%}
                                    <button type="submit" name="delete comment" value="{{sub_key}}">
                                        <i class="material-icons" style="font-size:15px;">delete</i>
                                    </button>
                                {%endif%}
                                {%if s.user_liked_comment%}
                                    <button type="submit" name="like comment" value="{{sub_key}}">
                                        <i class="material-icons" style="font-size:15px;">thumb_up</i>
                                        {{s.comment_like_count}}
                                    </button>
                                {%else%}
                                    <button type="submit" name="like comment" value="{{sub_key}}">
                                        <i class="material-icons" style="font-size:15px;">thumb_up</i>
                                        {{s.comment_like_count}}
                                    </button>
                                {%endif%}
                                {%if s.user_unliked_comment%}
                                    <button type="submit" name="unlike comment" value="{{sub_key}}">
                                        <i class="material-icons" style="font-size:15px;">thumb_down</i>
                                        {{s.comment_unlike_count}}
                                    </button>
                                {%else%}
                                    <button type="submit" name="unlike comment" value="{{sub_key}}">
                                        <i class="material-icons" style="font-size:15px;">thumb_down</i>
                                        {{s.comment_unlike_count}}
                                    </button>
                                {%endif%}
                            </div>
                        </div>
                    {%endfor%}
                </div>
            {%else%}
                <div class="comment">
                    <div class="comment_user_and_date">
                        <div class="user_image_and_name">
                            {%if c.photo%}
                                <img src="{{c.photo}}">
                            {%else%}
                                <img src="{% static '/appdefaults/add-photo3.png' %}" alt="add image" class="rounded-circle">
                            {%endif%}
                            <text>{{c.user_name}}</text>
                        </div>
                        <text class="date">{{c.date.date}}</text>
                    </div>
                    <text class="comment_text">{{c.comment}}</text>

                    <div class="like_reply_comment">
                        {%if c.user_name == request.user.get_full_name%}
                            <button type="submit" name="delete comment" value="{{key}}">
                                <i class="material-icons" style="font-size:15px;">delete</i>
                            </button>
                        {%endif%}
                        {%if c.user_liked_comment%}
                            <button type="submit" name="like comment" value="{{key}}">
                                <i class="material-icons" style="font-size:15px;">thumb_up</i>
                                {{c.comment_like_count}}
                            </button>
                        {%else%}
                            <button type="submit" name="like comment" value="{{key}}">
                                <i class="material-icons" style="font-size:15px;">thumb_up</i>
                                {{c.comment_like_count}}
                            </button>
                        {%endif%}
                        {%if c.user_unliked_comment%}
                            <button type="submit" name="unlike comment" value="{{key}}">
                                <i class="material-icons" style="font-size:15px;">thumb_down</i>
                                {{c.comment_unlike_count}}
                            </button>
                        {%else%}
                            <button type="submit" name="unlike comment" value="{{key}}">
                                <i class="material-icons" style="font-size:15px;">thumb_down</i>
                                {{c.comment_unlike_count}}
                            </button>
                        {%endif%}
                        <button type="button" name="reply to comment" value="{{key}}"  onclick="replyTo('{{key}}', '{{c.user_name}}')">
                            <i class="material-icons" style="font-size:15px;">reply</i>reply
                        </button>
                    </div>
                </div>
            {%endif%}
        {%endfor%}
    </div>
    <div class="comment_input">
        <text id="replyingTo">Add Comment</text>
        <input type="text" name="new comment" maxlength="4590" placeholder="comment........">
        <button type="submit" id="addComment" name="add comment" value="{{comment_id}}">
                <i class="material-icons" style="font-size:20px;">send</i>
        </button>
    </div>
</form>

<!--
<form method="post" id="commentReplyForm" class="comment_reply_form">
    {%csrf_token%}
    <div class="close_comment_reply_form">
        <button type="button" onclick="closeCommentReplyForm()">
            <i class="material-icons" style="font-size:20px;">close</i>
        </button>
    </div>
    <label id="displayText">Add Comment</label>
    <input type="text" required name="new_comment" maxlength="4590" placeholder="comment........">
    <button type="submit" id="commentId" name="add comment" value="{{comment_id}}">
            <i class="material-icons" style="font-size:20px;">send</i>
    </button>
</form>
-->

<script>
    navigationBar = document.getElementById("navigationBar");

    let lastScrollPosition = 0
    window.addEventListener('scroll', function(){
        const currentScrollPosition = window.scrollY;

        if (currentScrollPosition > lastScrollPosition && currentScrollPosition > 55){
            navigationBar.classList.add('hide_navigation_bar');
            nav_but.classList.add('hide_navigation_bar');
        }else {
            navigationBar.classList.remove('hide_navigation_bar');
            nav_but.classList.remove('hide_navigation_bar');
        }

        lastScrollPosition = currentScrollPosition ;
    });

    <!--comment form-->
    let commentsForm = document.getElementById("comments");

    function openCommentsForm(){
        commentsForm.classList.add("open_comments");
    }
    function closeCommentsForm(){
        commentsForm.classList.remove("open_comments");
    }

    <!-- reply to comment-->

    function replyTo(rootId, rootName){
        document.getElementById("addComment").value = rootId;
        document.getElementById("replyingTo").textContent = `Replying To:  ${rootName}`;
    }

    let lpv = document.getElementById("lpv");
    let currentImage = document.getElementById("currentImage");
    let prevImg = document.getElementById("previousImage");
    let nextImg = document.getElementById("nextImage");

    let contact = document.getElementById("contact");

    let currentIndex = 0
    let previousIndex = 0


    prevImg.addEventListener("click", previousImage);
    nextImg.addEventListener("click", nextImage);


    function nextImage(){
        let List = [{%for i in product.images%} '{{i}}', {%endfor%}]
        let limit = List.length-1
        if (currentIndex < limit){
            currentIndex +=1
            previousIndex = currentIndex - 1
            }else{
            }
        currentImage.src = List[currentIndex]

        previousCurtain = document.getElementById(previousIndex);
        previousCurtain.classList.remove("remove_curtain");
        previousCurtain.classList.add("image_curtain");

        currentCurtain = document.getElementById(currentIndex).classList.add("remove_curtain");
    }
    function previousImage(){
    let List = [{%for i in product.images%} '{{i}}', {%endfor%}]
        if (currentIndex >= 1){
            currentIndex -=1
            previousIndex = currentIndex + 1
            }else{
            currentIndex=currentIndex
            }
        currentImage.src = List[currentIndex]

        previousCurtain = document.getElementById(previousIndex);
        previousCurtain.classList.remove("remove_curtain");
        previousCurtain.classList.add("image_curtain");
        currentCurtain = document.getElementById(currentIndex).classList.add("remove_curtain");

    }

    document.addEventListener('keydown', function(event){
        if (event.key === 'ArrowLeft'){
            previousImage();
        }
        if (event.key === 'ArrowRight'){
            nextImage();
        }
        if (event.key === 'BackSpace'){
            window.history.go(-1);
        }
    });

   function showContact(){
       contact.classList.add("showContact");
   }
   function hideContact(){
       contact.classList.remove("showContact");
   }

    <!-- messages -->
    let mssg = document.getElementById("mssg");

    function closeMssg(){
        mssg.classList.add("hide");
    }

</script>